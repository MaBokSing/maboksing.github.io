<!DOCTYPE html>

<head>
    <title>ZhananSha</title>
</head>

<body>

    <div id="menu">
    </div>
    <div id="formArea">
    </div>

</body>

<script type="module">

    //Default login panel
    var formType = 'loginForm';
    formSwitch(formType);

    //Switch to Login or Register panel
    function formSwitch() {
        if (formType == 'loginForm') {
            document.getElementById('formArea').innerHTML = `
                <form id="loginForm">
                    <div class="container">
                        <h1>Login</h1>
                        <p>Please fill in the form to login</p>
                        <hr>

                        <label for="email"><b>Email</b></label>
                        <input type="text" placeholder="Enter Email" name="email" id="email" required>

                        <br>
                        <label><b>Password</b></label>
                        <input type="password" placeholder="Password" name="password" id="password" required>

                        <br>
                        <button type="button" id="submit" name="submit" class="loginbtn">Login</button>
                    </div>

                    <div class="container login">
                        <p>Don't have an account? <a href="#register" id="formSwitch">Register</a>.</p>
                    </div>
                </form>
            `;
            //Tips: dont use onclick in HTML form, please use addEventListener
            document.getElementById("submit").addEventListener("click", submitForm, false);
            document.getElementById("formSwitch").addEventListener("click", () => { formType = 'registerForm'; formSwitch(); }, false);
        } else if (formType == 'registerForm') {
            document.getElementById('formArea').innerHTML = `
                <form id="registerForm">
                    <div class="container">
                        <h1>Register</h1>
                        <p>Please fill in the form to create an account</p>
                        <hr>

                        <label for="email"><b>Email</b></label>
                        <input type="text" placeholder="Enter Email" name="email" id="email" required>

                        <br>
                        <label><b>Password</b></label>
                        <input type="password" placeholder="Password" name="password1" id="password1" required>

                        <br>
                        <label><b>Password (Repeat again)</b></label>
                        <input type="password" placeholder="Password" name="password2" id="password2" required>

                        <br>
                        <button type="button" id="submit" name="submit" class="registerbtn">Register</button>
                    </div>

                    <div class="container signin">
                        <p>Already have an account? <a href="#login" id="formSwitch">Sign In</a>.</p>
                    </div>
                </form>
            `;
            document.getElementById("submit").addEventListener("click", submitForm, false);
            document.getElementById("formSwitch").addEventListener("click", () => { formType = 'loginForm'; formSwitch(); }, false);
        }
    }

    // Import the functions you need from the SDKs you need
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-app.js";
    import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-auth.js";
    import { getDatabase, set, ref, update } from "https://www.gstatic.com/firebasejs/9.16.0/firebase-database.js"
    // TODO: Add SDKs for Firebase products that you want to use
    // https://firebase.google.com/docs/web/setup#available-libraries

    // Your web app's Firebase configuration
    const firebaseConfig = {
        apiKey: "AIzaSyARiZdJmeN3KoMiNEY4ZFY3gjsgw4Z0_b4",
        authDomain: "zhanan-sha.firebaseapp.com",
        databaseURL: "https://zhanan-sha-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "zhanan-sha",
        storageBucket: "zhanan-sha.appspot.com",
        messagingSenderId: "239659692532",
        appId: "1:239659692532:web:f063804c02ebb6725849a1"
    };

    // Initialize Firebase
    const app = initializeApp(firebaseConfig);
    const auth = getAuth();
    const database = getDatabase(app);

    //Fetch client ip address
    async function getIp() {
        //return (await (await fetch('https://api.ipify.org/?format=json')).json()).ip;
        return (await (await fetch('https://ipinfo.io/json')).json()).ip;
        //return (await (await fetch('http://ip-api.com/json/?fields=61439')).json()).query;
        //return (await (await fetch('https://ipinfo.io')).json()).ip;
    }
    var ip_address = await getIp();

    //When Submit Button pressed
    function submitForm() {

        //Register
        if (formType == 'registerForm') {
            var email = document.getElementById('email').value;
            var password = document.getElementById('password1').value;
            var rptPassword = document.getElementById('password2').value;

            if (rptPassword == password) {

                //Register
                createUserWithEmailAndPassword(auth, email, password)
                    .then((userCredential) => {
                        // Signed in
                        const user = userCredential.user;
                        // ... user.uid
                        set(ref(database, 'users/' + user.uid), {
                            email: email,
                            password: password
                        })
                            .then(() => {
                                // Data saved successfully!
                                alert('user created successfully');
                                formType = 'loginForm';
                                formSwitch();
                            })
                            .catch((error) => {
                                // The write failed...
                                alert(error);
                            });
                    })
                    .catch((error) => {
                        const errorCode = error.code;
                        const errorMessage = error.message;
                        // ..
                        alert(errorMessage);
                    });
            } else {
                alert("Repeat password wrong.");
            };
        };

        //Login
        if (formType == 'loginForm') {
            var email = document.getElementById('email').value;
            var password = document.getElementById('password').value;

            //Login
            signInWithEmailAndPassword(auth, email, password)
                .then((userCredential) => {
                    // Signed in
                    const user = userCredential.user;

                    var lgDate = new Date();
                    update(ref(database, 'users/' + user.uid), {
                        last_login: lgDate,
                        ip_address: ip_address
                    })
                        .then(() => {
                            // Data saved successfully!
                            alert('User ' + email + ' logged in successfully');
                            if (user) {
                                //User is signed in
                                update(ref(database, 'users/' + user.uid), {
                                    online: true
                                })

                                //Create logout button and its function
                                document.getElementById("menu").innerHTML += `
                                    <div id="loginStatus" style="position: absolute; top: 15px; right: 20px;">
                                        <label id="account"></label>
                                        <button id="logOut">Log out</button>
                                    </div>
                                `
                                document.getElementById("account").innerHTML = email;
                                document.getElementById("logOut").addEventListener("click", logOut, false);

                            }
                        })
                        .catch((error) => {
                            // The write failed...
                            alert(error);
                        });
                })
                .catch((error) => {
                    const errorCode = error.code;
                    const errorMessage = error.message;
                    alert(errorMessage);
                });
        };

    };

    // const user = auth.currentUser;
    // onAuthStateChanged(auth, (user) => {
    //     if (user) {
    //         //User is signed in
    //         update(ref(database, 'users/' + user.uid), {
    //             online: true
    //         })

    //         //Create logout button and its function
    //         document.getElementById("menu").innerHTML += `
    //             <div id="loginStatus" style="position: absolute; top: 15px; right: 20px;">
    //                 <label id="account"></label>
    //                 <button id="logOut">Log out</button>
    //             </div>
    //         `
    //         document.getElementById("account").innerHTML = document.getElementById('email').value;
    //         document.getElementById("logOut").addEventListener("click", logOut, false);

    //         // } else {
    //         //     //User is signed out
    //         //     update(ref(database, 'users/' + user.uid), {
    //         //         online: false
    //         //     })
    //     }
    // });

    function logOut() {
        const user = auth.currentUser;
        update(ref(database, 'users/' + user.uid), {
            online: false
        })
        document.getElementById('loginStatus').remove();

        signOut(auth)
            .then(() => {
                //Signout successfully
                alert('User ' + user.email + ' signed out.');
            })
            .catch((error) => {
                const errorCode = error.code;
                const errorMessage = error.message;
                alert(errorMessage);
            });
    }

    //When user refreshed or closed the page
    window.onbeforeunload = function () {
        logOut();
    }

</script>

</html>